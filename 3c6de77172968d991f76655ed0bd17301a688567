{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "76d43e66_e0bebd9f",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 163,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-14T23:23:54Z",
      "side": 1,
      "message": "The actual assignment happens at L169, and currently for the code, this may race with multiple threads (since the lock in assignServerToThisThread is taken separately from the one in ExclusiveSocket).",
      "range": {
        "startLine": 162,
        "startChar": 0,
        "endLine": 163,
        "endChar": 87
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "13408b5b_2eec7ca2",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 163,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-04-14T23:54:48Z",
      "side": 1,
      "message": "Aha! No wonder why the tid is always nullopt.\n\nI\u0027ll move it.",
      "parentUuid": "76d43e66_e0bebd9f",
      "range": {
        "startLine": 162,
        "startChar": 0,
        "endLine": 163,
        "endChar": 87
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a16b0acf_03dc01e9",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 180,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-14T23:23:54Z",
      "side": 1,
      "message": "so sometimes, this will drop a different server than we are actually using with L169. Try adding a check that the removed thread object is the same as the one selected by the ExclusiveSocket - I would expect it to fail on binderRpcTest frequently.",
      "range": {
        "startLine": 180,
        "startChar": 0,
        "endLine": 180,
        "endChar": 49
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a64dcde0_a687d438",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 180,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-04-14T23:27:53Z",
      "side": 1,
      "message": "So, maybe I should be dropping the one selected by ExclusiveSocket instead? I am not sure what\u0027s the correct thing to do; all I know is that clientFd (L152) is now invalid and should be dropped from the list, IIUC",
      "parentUuid": "a16b0acf_03dc01e9",
      "range": {
        "startLine": 180,
        "startChar": 0,
        "endLine": 180,
        "endChar": 49
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2824ddb9_e9bebbb2",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 180,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-14T23:59:56Z",
      "side": 1,
      "message": "Yeah. ExclusiveSocket is the one actually being used by this thread. clientFd no longer exists in this scope. socket.fd() is used. This might be clientFd or it might not.\n\nAlso - we can definitely fix this if you want, but it requires holding the lock for longer and potentially \u0027Locked\u0027 versions of the function.\n\nNote - the reason why ExclusiveSocket needs to get involved is for nested transactions.\n\nMaybe the easiest way to fix this would be to set the value of the optional TID inside of the assignServerToThisThread.",
      "parentUuid": "a64dcde0_a687d438",
      "range": {
        "startLine": 180,
        "startChar": 0,
        "endLine": 180,
        "endChar": 49
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a7137487_ae539c22",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 180,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-04-15T00:11:25Z",
      "side": 1,
      "message": "This needs to be fixed. Without this, the server thread continues to read data from a dead fd after the client disconnects, because of the behavior of ExclusiveSocket.\n\n\u003e Maybe the easiest way to fix this would be to set the value of the optional TID inside of the assignServerToThisThread.\n\nAre you suggesting to use tid as the identifier to look up the object to remove? I can do that.",
      "parentUuid": "2824ddb9_e9bebbb2",
      "range": {
        "startLine": 180,
        "startChar": 0,
        "endLine": 180,
        "endChar": 49
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "861d24aa_edd52232",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 180,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-15T00:16:11Z",
      "side": 1,
      "message": "I mean \"connection-\u003eexclusiveTid \u003d gettid()\" in assignServerToThisThread would fix the race discussed in PS3 L166-168.\n\n\u003e use tid as the identifier to look up the object to remove? \n\nThere is no need to look it up since ExclusiveSocket keeps it in mSocket. That is one this thread is using.",
      "parentUuid": "a7137487_ae539c22",
      "range": {
        "startLine": 180,
        "startChar": 0,
        "endLine": 180,
        "endChar": 49
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b195eea2_debe47ee",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 243,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-14T23:23:54Z",
      "side": 1,
      "message": "you might want to sync, given large change https://android-review.googlesource.com/c/platform/frameworks/native/+/1664341",
      "range": {
        "startLine": 243,
        "startChar": 37,
        "endLine": 243,
        "endChar": 61
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cb7a6027_7c06a188",
        "filename": "libs/binder/RpcConnection.cpp",
        "patchSetId": 3
      },
      "lineNbr": 243,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-04-14T23:54:48Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "b195eea2_debe47ee",
      "range": {
        "startLine": 243,
        "startChar": 37,
        "endLine": 243,
        "endChar": 61
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8103312f_5d8ebd88",
        "filename": "libs/binder/include/binder/RpcConnection.h",
        "patchSetId": 3
      },
      "lineNbr": 123,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-04-14T23:23:54Z",
      "side": 1,
      "message": "FYI this will conflict with https://android-review.googlesource.com/c/platform/frameworks/native/+/1673557",
      "range": {
        "startLine": 123,
        "startChar": 0,
        "endLine": 123,
        "endChar": 72
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd55a3ce_e30f869b",
        "filename": "libs/binder/include/binder/RpcConnection.h",
        "patchSetId": 3
      },
      "lineNbr": 123,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-04-14T23:54:48Z",
      "side": 1,
      "message": "Ack, I\u0027ll wait",
      "parentUuid": "8103312f_5d8ebd88",
      "range": {
        "startLine": 123,
        "startChar": 0,
        "endLine": 123,
        "endChar": 72
      },
      "revId": "3c6de77172968d991f76655ed0bd17301a688567",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}