{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "1b7ed99f_25410cde",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2022-05-23T23:45:02Z",
      "side": 1,
      "message": "what if it needs to work with the single-threaded version?",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "943cbcab_8eb0e402",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-19T00:52:25Z",
      "side": 1,
      "message": "Right now the single-threaded version is only used for internal testing, do we want to use it for anything else?",
      "parentUuid": "1b7ed99f_25410cde",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cf26bf35_58cc8db8",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2022-07-25T23:02:27Z",
      "side": 1,
      "message": "Ah, so the multi-threaded version running in Android will communicate with the single-threaded version running here? That does work? Actually - that is fantatic",
      "parentUuid": "943cbcab_8eb0e402",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e29c7612_e1ef93d3",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-26T01:19:53Z",
      "side": 1,
      "message": "I need to add some tests for that, but it should work. The Trusty side should be able to accept multiple connections at the same time, it will just handle all of them sequentially on the main thread.\n\nThe Trusty side will return 1 for `getRemoteMaxThreads` so the client shouldn\u0027t open more than 1 outgoing connection. The default for incoming threads is 0, so that should be fine too.",
      "parentUuid": "cf26bf35_58cc8db8",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d1a12bcd_fdb341ea",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-27T01:07:17Z",
      "side": 1,
      "message": "The test at https://android-review.googlesource.com/c/platform/system/core/+/2045930 works with shared libbinder and with the default thread configuration.",
      "parentUuid": "e29c7612_e1ef93d3",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ecb0d3ca_23549958",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2022-07-27T21:32:05Z",
      "side": 1,
      "message": "\u003e The Trusty side should be able to accept multiple connections at the same time, it will just handle all of them sequentially on the main thread.\n\nI\u0027m most concerned about nested transactions here. Could we test these (or could we add this into binderRpcTest so that this variation is tested w/ all the different things there and future features as well)?\n\n\u003e so the client shouldn\u0027t open more than 1 outgoing connection\n\nIf it tries, Trusty will reject it right? Or because there is no \u0027join\u0027 thread, it will hang? (in which case, we should set the listener backlog to \u00270\u0027 in the single threaded case - though I\u0027m not sure if this would affect trusty b/c it isn\u0027t using sockets)",
      "parentUuid": "d1a12bcd_fdb341ea",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7cd4ce02_1a50b802",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-28T02:38:55Z",
      "side": 1,
      "message": "\u003e If it tries, Trusty will reject it right? Or because there is no \u0027join\u0027 thread, it will hang?\n\nNeither actually, it should work fine. Trusty libbinder is a little ahead of the single-threaded Android library, because the Trusty code uses a tipc_srv helper library with a semi-async API. tipc_srv does a single wait() call in the main event loop for all the connections (channels in TIPC) it knows about from libbinder. Whenever a message comes in on a specific channel, this library calls the message handler, which in turn calls drainCommands() for that RpcSession. With this design, Trusty libbinder should handle a (theoretically) arbitrary number of incoming connections, but can only handle one transaction at a time.\n\nWe probably should test this though.",
      "parentUuid": "ecb0d3ca_23549958",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "df247a3f_9a39a611",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-28T05:17:33Z",
      "side": 1,
      "message": "\u003e If it tries, Trusty will reject it right?\n\nUpdate: this was correct. If a service gets more than `mMaxThreads`/`mMaxIncomingThreads` connections at a time, `RpcSession` starts rejecting them in `assignIncomingConnectionToThisThread` (https://cs.android.com/android/platform/superproject/+/master:frameworks/native/libs/binder/RpcSession.cpp;l\u003d752). The default for `mMaxThreads` is 1.\n\nI think a Trusty service could call `setMaxThreads` with a higher value and it would work fine, but I need to test this to confirm.",
      "parentUuid": "7cd4ce02_1a50b802",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7de5cdf7_70d3b1c1",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-29T03:36:13Z",
      "side": 1,
      "message": "Update 2: after looking into this some more, I think the above still holds. The default `mMaxThreads` of 1 means that Trusty\u0027s `RpcServerTrusty` will only accept one connection per session and reject extra ones. No non-buggy client would even attempt more than that because it asks the service for `GET_MAX_THREADS` and limits its connection attempts at that.\n\nA Trusty service implementation wouldn\u0027t even be able to call `setMaxThreads` because `RpcServerTrusty` doesn\u0027t expose that method from `RpcServer`. Our implementation would have to explicitly raise that maximum, but it makes no sense to do so because there is no hardware parallelism to use. All connections would be handled sequentially on the main thread.",
      "parentUuid": "df247a3f_9a39a611",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9aa0335a_c0d24c08",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 313,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2022-08-16T21:45:31Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "7de5cdf7_70d3b1c1",
      "range": {
        "startLine": 313,
        "startChar": 9,
        "endLine": 313,
        "endChar": 18
      },
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "62c33e2e_fdd45e6e",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 320,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2022-07-25T23:02:27Z",
      "side": 1,
      "message": "nit: control visibility here as well? Are we worried about too many additional users?",
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "abfdc207_3763a4f5",
        "filename": "libs/binder/Android.bp",
        "patchSetId": 68
      },
      "lineNbr": 320,
      "author": {
        "id": 1809582
      },
      "writtenOn": "2022-07-27T00:59:06Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "62c33e2e_fdd45e6e",
      "revId": "b334c594eaa414f31111efc9d8fa2adbcf2c1f8d",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}