{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "ebf42918_e294a3ac",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 238,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "Actually this checks for /data/data. /data/user/0 is handled below.",
      "range": {
        "startLine": 238,
        "startChar": 11,
        "endLine": 238,
        "endChar": 27
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5549e6a9_d13079c5",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 238,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ebf42918_e294a3ac",
      "range": {
        "startLine": 238,
        "startChar": 11,
        "endLine": 238,
        "endChar": 27
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d2c8945a_f7ea1522",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 318,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "Nit: dup can fail.",
      "range": {
        "startLine": 318,
        "startChar": 37,
        "endLine": 318,
        "endChar": 40
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "cf72322d_05e02ede",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 318,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "d2c8945a_f7ea1522",
      "range": {
        "startLine": 318,
        "startChar": 37,
        "endLine": 318,
        "endChar": 40
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ebbfb36_2560edde",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 329,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T19:20:07Z",
      "side": 1,
      "message": "How are we avoiding an fd leak here?",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4bf2ec17_61c17a40",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 329,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "BnFsveritySetupAuthToken is managed by the kernel binder device. It\u0027s a bit magical to me, but the binder experts told me the kernel will release it (which triggers the dtor) when no one holds a reference to the binder object. I added some explanation to the empty AIDL interface.",
      "parentUuid": "8ebbfb36_2560edde",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fad0f71b_34dc7719",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3911,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "Notably",
      "range": {
        "startLine": 3911,
        "startChar": 3,
        "endLine": 3911,
        "endChar": 10
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "921afc67_6d08c604",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3911,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "fad0f71b_34dc7719",
      "range": {
        "startLine": 3911,
        "startChar": 3,
        "endLine": 3911,
        "endChar": 10
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e2086669_d1e0c790",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T19:20:07Z",
      "side": 1,
      "message": "is this only because we need writable fd? can we send both writable and read-only fd into enableFsverity, and close the writable one?",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "94d2ecc6_1444035a",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "I didn\u0027t split into two methods initially.  I guess there are two things to explain here...\n\nWhy splitting into two methods? In my initial impl, I realize the AIDL-generated code duplicates the writable FD on the caller side (remember fs-verity setup requires no writable FD), and it\u0027s super tricky to avoid that after talking to Steven.  I figured it\u0027s the easiest to split into two: once the first/createFsveritySetupAuthToken returns, the writable FD can be closed.  Then only the server holds the reference to the writable FD.\n\nWhy only writable FD here?  Since we think path validation is still valuable in addition to the FD authentication, we can open the read-only FD from path.  Originally, I have 3 `struct stat` and `memcpy` them: from the writable FD, from the readable FD, and from the path.  I figured we can drop the read-only one.",
      "parentUuid": "e2086669_d1e0c790",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5506cf90_e6f52786",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T21:04:04Z",
      "side": 1,
      "message": "Well, you are passing writable fd back to enableFsverity, albeit wrapped inside FsveritySetupAuthToken? How is it different from just passing ParcelFileDescriptor?",
      "parentUuid": "94d2ecc6_1444035a",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2dfcc1ee_879e2c06",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:12:15Z",
      "side": 1,
      "message": "When a client creates a PFD, it holds the FD. Not until the call returns, it can manually close the FD.  So for example, if we only have 1 enableFsverity, because the client hasn\u0027t closed the writable FD, the server can\u0027t enable fs-verity successfully. See ag/24326119.\n\n(I first tried to do it in binder, but apparently it\u0027s a huge surgery.)",
      "parentUuid": "5506cf90_e6f52786",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d3d51c05_a8813a2e",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T21:46:13Z",
      "side": 1,
      "message": "Since we are only using it to obtain stats, should we store the stats in the object? I am not super comfortable relying on this very fragile logic.",
      "parentUuid": "2dfcc1ee_879e2c06",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "15752c64_337dc456",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3915,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T22:43:19Z",
      "side": 1,
      "message": "Oh I like the idea :)  I also moved the code slightly.",
      "parentUuid": "d3d51c05_a8813a2e",
      "range": {
        "startLine": 3915,
        "startChar": 36,
        "endLine": 3915,
        "endChar": 42
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ed33142b_07fd13c6",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3936,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "Please fix this ERROR reported by Common Typos: Common typo found: \"the the\" -- should it be \"the\"?\n\nAnalyzer Description: Linter for catching common typos motivated by go/todo-fail and go/lol-codesearch. Shared with google3 common typos library go/common-typos.\nOwner: ayeaye-team@google.com\n\nCommon typo found: \"the the\" -- should it be \"the\"?\nNote: a line containing \"common_typos_disable\" or \"common_typos_enable\" will turn off or on (respectively) the linter for subsequent lines in the file. Alternatively include the token \"NOTYPO\" within a line to skip typo linting that line or include \u0027No-Typo-Check: \u003creason\u003e\u0027in the commit message.",
      "range": {
        "startLine": 3936,
        "startChar": 25,
        "endLine": 3936,
        "endChar": 32
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5bd77c9d_02379d50",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3936,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "ed33142b_07fd13c6",
      "range": {
        "startLine": 3936,
        "startChar": 25,
        "endLine": 3936,
        "endChar": 32
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9964d426_29fe27af",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3947,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "That feels like a slightly weak check. Check it\u0027s a valid app uid, or at least not a system uid?",
      "range": {
        "startLine": 3947,
        "startChar": 4,
        "endLine": 3947,
        "endChar": 21
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "15716e3b_761bd536",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3947,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "9964d426_29fe27af",
      "range": {
        "startLine": 3947,
        "startChar": 4,
        "endLine": 3947,
        "endChar": 21
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c868808a_59848c1b",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3982,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "I think this won\u0027t work for userId !\u003d 0.\nThe file will have the combined uid, encoding userId + appId.",
      "range": {
        "startLine": 3982,
        "startChar": 7,
        "endLine": 3982,
        "endChar": 64
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "274d7caa_37f3e025",
        "filename": "cmds/installd/InstalldNativeService.cpp",
        "patchSetId": 8
      },
      "lineNbr": 3982,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Good catch. Done",
      "parentUuid": "c868808a_59848c1b",
      "range": {
        "startLine": 3982,
        "startChar": 7,
        "endLine": 3982,
        "endChar": 64
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "65278034_487c6aa8",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T16:36:46Z",
      "side": 1,
      "message": "ok, this is definitely an overkill. we are doing way more sensetive operations in installd just by checking a path. let\u0027s do just that",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e8008c4f_e447ac7b",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T18:16:26Z",
      "side": 1,
      "message": "Err, I thought you were concerned about the arguments spoofed by the caller / system server?  Why is path checking sufficient?\n\nWhat is the way more sensitive operation?  Besides the fs-verity ioctl, everything else is read-only.",
      "parentUuid": "65278034_487c6aa8",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "89941a13_8ae382c0",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T18:33:46Z",
      "side": 1,
      "message": "Sorry, I might not have been clear enough.\nMy personal concern is that an app can put a symlink in their path.\nThe concern of security team is that system_server can send an invalid path.\n\nThey are both can be addressed by using a rather simple validation-and-open e.g.:\n\nhttps://source.corp.google.com/h/googleplex-android/platform/superproject/main/+/main:system/vold/Utils.cpp;l\u003d1727-1762?q\u003dopenat%20vold\u0026sq\u003drepo:googleplex-android%2Fplatform%2Fsuperproject%2Fmain%20b:main\n\nre: more sensitive operation. not in this method, but across installd",
      "parentUuid": "e8008c4f_e447ac7b",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63471025_8399c69d",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T18:59:37Z",
      "side": 1,
      "message": "The security concern isn\u0027t an \"invalid path\" (from the link, I assume by \"invalid\" you imply only the path \"structure\", i.e. symlink and existence), but perhaps \"arbitrary path\".  I thought we\u0027re treating installd as a super privilege domain and want a high security bar.  For example, we need to consider what can happen when a system server is compromised, right? Otherwise why the domain separation?  Arguably we\u0027re only enabling fs-verity to files, so it isn\u0027t a huge problem if we allow an attacker to abuse the API.\n\nDoes anyone on security feel a path check is sufficient?  Not sure who on security has more knowledge about installd.  Otherwise, I don\u0027t feel this is an overkill given the installd privilege.",
      "parentUuid": "89941a13_8ae382c0",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7b72426c_8b36f4e2",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-07T19:20:07Z",
      "side": 1,
      "message": "My feedback was based on the security bugs we received for this component.",
      "parentUuid": "63471025_8399c69d",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9ffa5a89_e99722a6",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 137,
      "author": {
        "id": 1166043
      },
      "writtenOn": "2023-08-11T02:38:42Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "7b72426c_8b36f4e2",
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "03280907_facfde48",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 138,
      "author": {
        "id": 1060831
      },
      "writtenOn": "2023-08-07T08:32:57Z",
      "side": 1,
      "message": "// Intentionally left blank\n\nOr a better explanation? Both to make it less ugly, and to make it clearer why there are no methods?",
      "range": {
        "startLine": 137,
        "startChar": 0,
        "endLine": 138,
        "endChar": 5
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e1befaf1_60014bb3",
        "filename": "cmds/installd/binder/android/os/IInstalld.aidl",
        "patchSetId": 8
      },
      "lineNbr": 138,
      "author": {
        "id": 1042276
      },
      "writtenOn": "2023-08-07T21:00:10Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "03280907_facfde48",
      "range": {
        "startLine": 137,
        "startChar": 0,
        "endLine": 138,
        "endChar": 5
      },
      "revId": "a408f4c10f3f811349331bb6014036ed350f353c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}