{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "be774566_286d16f8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-01T13:23:42Z",
      "side": 1,
      "message": "I just wanted to follow up on this one. It looks like we are getting some build failures, but I don\u0027t have access to the verification jobs to see what they are. If there are any changes needed to resolve the build failures please let me know. ",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dcef550c_994f30a7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1149384
      },
      "writtenOn": "2022-08-02T21:32:02Z",
      "side": 1,
      "message": "Most likely presubmit was broken at the time, let me retry a few more times.",
      "parentUuid": "be774566_286d16f8",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7c37cf76_732ac53e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1149384
      },
      "writtenOn": "2022-08-03T01:26:46Z",
      "side": 1,
      "message": "The failures appear to be consistent.\n\nDo you mind trying to run:\n\n  `cd frameworks/native/services/inputflinger \u0026\u0026 atest`\n  \nto run everything.\n\nThe one I\u0027m seeing failing on master is:\n\n `atest CtsHardwareTestCases`\n \nBoth invocations would require an adb connection with a real device. These tests run on a device, ensure the screen is ON and home screen is shown when the test runs.",
      "parentUuid": "dcef550c_994f30a7",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "080c840f_4c735349",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-03T16:41:05Z",
      "side": 1,
      "message": "Thanks. I rebased my patch on the latest master as of this morning and am building the car_x86_64-userdebug target.\n\nI do see the following test failures:\nSummary (Test executed with 1 devices.)\n-------\nx86_64 CtsGraphicsTestCases: Passed: 2, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 CtsInputTestCases: Passed: 4, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 CtsSecurityTestCases: Passed: 1, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 CtsViewTestCases: Passed: 8, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 CtsWindowManagerDeviceTestCases: Passed: 15, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 FrameworksCoreTests: Passed: 7, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 InputTests: Passed: 12, Failed: 1, Ignored: 0, Assumption Failed: 0,    \nx86_64 SurfaceFlinger_test: Passed: 116, Failed: 2, Ignored: 0, Assumption Failed: 0,    \nx86_64 inputflinger_tests: Passed: 348, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 libinput_tests: Passed: 101, Failed: 0, Ignored: 0, Assumption Failed: 0,    \nx86_64 libinputservice_test: Passed: 4, Failed: 0, Ignored: 0, Assumption Failed: 0,    \n\n3 tests failed\n--------------\ncom.android.test.input.AnrTest#testGestureMonitorAnr\nScreenCaptureTest#CaptureCrop\nScreenCaptureTest#CaptureSize\nTest Logs have saved in /tmp/atest_result/20220803_111247_2zlkwlg4/log\n\nI built without my patch applied and see the same failures, however the ScreenCaptureTest failures don\u0027t always happen.\n\nHowever I think I just realized that the the failures you are referring to are in CtsHardwareTestCases which I don\u0027t see running here. I think by \u0027real\u0027 device you mean I need a hardware device to test with instead of an emulator? Unfortunately I don\u0027t have this as the bsp package we are using on our hardware is android 12. However I assume CtsHardwareTestCases have likely not changed that much upstream from where our hardware is at. I can run CtsHardwareTestCases on our hardware with and without my patch to see if I can introduce the same failures there. I can also take a look at the source for CtsHardwareTestCases to see if I can figure out what might be breaking there. Perhaps a test is relying on getting back the same descriptor for 2 devices if they provide the same vendor, product, revision and unique id?",
      "parentUuid": "7c37cf76_732ac53e",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ee834bda_28694d06",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1149384
      },
      "writtenOn": "2022-08-03T16:54:36Z",
      "side": 1,
      "message": "It\u0027s not running on aosp because we didn\u0027t add CtsHardwareTestCases to TEST_MAPPING, since those tests were unstable at the time. Now they are more stable, and are running in presubmit internally.\n\nYou can try running on emulator as well. The failures are like this:\n\n```\njava.lang.RuntimeException: Did not receive device added notification in time\njava.lang.RuntimeException: Did not receive device added notification in time\n\tat com.android.cts.input.VirtualInputDevice.registerInputDevice(VirtualInputDevice.java:148)\n\tat com.android.cts.input.VirtualInputDevice.\u003cinit\u003e(VirtualInputDevice.java:109)\n\tat com.android.cts.input.HidDevice.\u003cinit\u003e(HidDevice.java:78)\n\tat android.hardware.input.cts.tests.InputHidTestCase.onSetUp(InputHidTestCase.java:112)\n\tat android.hardware.input.cts.tests.InputTestCase.setUp(InputTestCase.java:100)\n\t```",
      "parentUuid": "080c840f_4c735349",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aa63fc7f_6acdbd0d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-03T17:34:15Z",
      "side": 1,
      "message": "Thanks. I was able to run CtsHardwareTestCases with the emulator and see that there are failures with this patch that are not present without the patch. I will dig into those failures to see what is happening.\n\nWith patch:\nSummary (Test executed with 1 devices.)\n-------\nx86_64 CtsHardwareTestCases: Passed: 58, Failed: 25, Ignored: 0, Assumption Failed: 25,    \n\n25 tests failed\n---------------\nandroid.hardware.cts.LowRamDeviceTest#test32BitOnlyIfLessThan2GiB\nandroid.hardware.cts.SecurityModelFeatureTest#testAuto\nandroid.hardware.input.cts.tests.SonyDualSenseBluetoothTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualSenseBluetoothTest#kernelModule\nandroid.hardware.input.cts.tests.SonyDualSenseBluetoothTest#testVibrator\nandroid.hardware.input.cts.tests.SonyDualSenseBluetoothTest#testAllMotions\nandroid.hardware.input.cts.tests.SonyDualSenseUsbTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualSenseUsbTest#testVibrator\nandroid.hardware.input.cts.tests.SonyDualSenseUsbTest#testAllMotions\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testAllTouch\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testBattery\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testLights\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testVibrator\nandroid.hardware.input.cts.tests.SonyDualshock4BluetoothTest#testAllMotions\nandroid.hardware.input.cts.tests.SonyDualshock4ProBluetoothTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualshock4ProBluetoothTest#testVibrator\nandroid.hardware.input.cts.tests.SonyDualshock4ProBluetoothTest#testAllMotions\nandroid.hardware.input.cts.tests.SonyDualshock4ProUsbTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualshock4ProUsbTest#testAllMotions\nandroid.hardware.input.cts.tests.SonyDualshock4UsbTest#testAllKeys\nandroid.hardware.input.cts.tests.SonyDualshock4UsbTest#testBattery\nandroid.hardware.input.cts.tests.SonyDualshock4UsbTest#kernelModule\nandroid.hardware.input.cts.tests.SonyDualshock4UsbTest#testVibrator\nandroid.hardware.input.cts.tests.SonyDualshock4UsbTest#testAllMotions\nTest Logs have saved in /tmp/atest_result/20220803_120730_wm8scpss/log\n\n\nWithout patch:\nSummary (Test executed with 1 devices.)\n-------\nx86_64 CtsHardwareTestCases: Passed: 81, Failed: 2, Ignored: 0, Assumption Failed: 25,    \n\n2 tests failed\n--------------\nandroid.hardware.cts.LowRamDeviceTest#test32BitOnlyIfLessThan2GiB\nandroid.hardware.cts.SecurityModelFeatureTest#testAuto\nTest Logs have saved in /tmp/atest_result/20220803_122144_786g3hz2/log",
      "parentUuid": "ee834bda_28694d06",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "31d83fef_0649ae35",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1149384
      },
      "writtenOn": "2022-08-03T17:46:03Z",
      "side": 1,
      "message": "Excellent, glad you were able to repro these!!",
      "parentUuid": "aa63fc7f_6acdbd0d",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b4e8bde5_8739815b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-04T13:47:54Z",
      "side": 1,
      "message": "Note: I had to split this into two comments since it exceed the comment length limit.\n\nThese tests definitely helped as I see where the issue is now. It looks like some input devices such as the Sony DualSense device has a single physical device that exposes multiple input sources (i.e a keyboard and a touchpad). The way InputFlinger is handling these is to treat the additional input sources from the device as \u0027sub devices\u0027 - it only created one InputDevice for them in EventReader, but multiple entries in EventHub. The tests for these devices expects only one InputDevice to be found in InputManager but expects all of the input sources to be reported on that single InputDevice. The way this was done was that EventHub would give the same descriptor to all of the devices if they had the same unique id field (the test sets the unique id field to these devices as \"00:00:00:00:00:00\" to tie them all together. \n\nSo the issue with this patch is that we now ensure the descriptor is unique for the additional sources which makes InputReader create a separate InputDevice for each source.\n\nHere are some extended logs I enabled while running the tests to help illustrate what is going on:\n\nHere is the case without my patch where the test succeeds:\n08-03 16:41:32.269     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) as /devices/virtual/misc/uhid/0003:054C:0CE6.0002/input/input17\n08-03 16:41:32.274     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors as /devices/virtual/misc/uhid/0003:054C:0CE6.0002/input/input18\n08-03 16:41:32.275     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad as /devices/virtual/misc/uhid/0003:054C:0CE6.0002/input/input19\n08-03 16:41:32.241   613   711 I EventHub: Opening device: /dev/input/event13\n08-03 16:41:32.251   613   711 I EventHub: add device 17: /dev/input/event13\n08-03 16:41:32.251   613   711 I EventHub:   bus:        0003\n08-03 16:41:32.251   613   711 I EventHub:   vendor      054c\n08-03 16:41:32.251   613   711 I EventHub:   product     0ce6\n08-03 16:41:32.251   613   711 I EventHub:   version     8000\n08-03 16:41:32.251   613   711 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test)\"\n08-03 16:41:32.251   613   711 I EventHub:   location:   \"\"\n08-03 16:41:32.251   613   711 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 16:41:32.251   613   711 I EventHub:   descriptor: \"281647cb23c613e9487705dd51a0705b6ed6da26\"\n08-03 16:41:32.251   613   711 I EventHub:   driver:     v1.0.1\n08-03 16:41:32.254   613   711 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027.\n08-03 16:41:32.256   613   711 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 16:41:32.265   613   711 W EventHub: Unable to disable kernel key repeat for /dev/input/event13: Function not implemented\n08-03 16:41:32.265   613   711 I EventHub: usingClockIoctl\u003dtrue\n08-03 16:41:32.265   613   711 I EventHub: New device: id\u003d17, fd\u003d499, path\u003d\u0027/dev/input/event13\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027, classes\u003dKEYBOARD | GAMEPAD | JOYSTICK | VIBRATOR | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027/system/usr/keylayout/Vendor_054c_Product_0ce6.kl\u0027, keyCharacterMap\u003d\u0027/system/usr/keychars/Generic.kcm\u0027, builtinKeyboard\u003dfalse, \n08-03 16:41:32.266   613   711 I EventHub: Opening device: /dev/input/event14\n08-03 16:41:32.283   613   711 I EventHub: add device 18: /dev/input/event14\n08-03 16:41:32.283   613   711 I EventHub:   bus:        0003\n08-03 16:41:32.283   613   711 I EventHub:   vendor      054c\n08-03 16:41:32.283   613   711 I EventHub:   product     0ce6\n08-03 16:41:32.283   613   711 I EventHub:   version     8000\n08-03 16:41:32.283   613   711 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\"\n08-03 16:41:32.283   613   711 I EventHub:   location:   \"\"\n08-03 16:41:32.283   613   711 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 16:41:32.283   613   711 I EventHub:   descriptor: \"281647cb23c613e9487705dd51a0705b6ed6da26\"\n08-03 16:41:32.283   613   711 I EventHub:   driver:     v1.0.1\n08-03 16:41:32.283   613   711 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027.\n08-03 16:41:32.283   613   711 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 16:41:32.285   613   711 I EventHub: usingClockIoctl\u003dtrue\n08-03 16:41:32.285   613   711 I EventHub: New device: id\u003d18, fd\u003d500, path\u003d\u0027/dev/input/event14\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027, classes\u003dSENSOR | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027/system/usr/keylayout/Vendor_054c_Product_0ce6.kl\u0027, keyCharacterMap\u003d\u0027/system/usr/keychars/Generic.kcm\u0027, builtinKeyboard\u003dfalse, \n08-03 16:41:32.285   613   711 I EventHub: Opening device: /dev/input/event15\n08-03 16:41:32.285   613   711 I EventHub: add device 19: /dev/input/event15\n08-03 16:41:32.285   613   711 I EventHub:   bus:        0003\n08-03 16:41:32.285   613   711 I EventHub:   vendor      054c\n08-03 16:41:32.285   613   711 I EventHub:   product     0ce6\n08-03 16:41:32.285   613   711 I EventHub:   version     8000\n08-03 16:41:32.285   613   711 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\"\n08-03 16:41:32.285   613   711 I EventHub:   location:   \"\"\n08-03 16:41:32.285   613   711 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 16:41:32.285   613   711 I EventHub:   descriptor: \"281647cb23c613e9487705dd51a0705b6ed6da26\"\n08-03 16:41:32.285   613   711 I EventHub:   driver:     v1.0.1\n08-03 16:41:32.285   613   711 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027.\n08-03 16:41:32.285   613   711 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 16:41:32.287   613   711 I EventHub: usingClockIoctl\u003dtrue\n08-03 16:41:32.287   613   711 I EventHub: New device: id\u003d19, fd\u003d495, path\u003d\u0027/dev/input/event15\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, classes\u003dTOUCH | TOUCH_MT | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027\u0027, keyCharacterMap\u003d\u0027\u0027, builtinKeyboard\u003dfalse, \n08-03 16:41:32.296   613   711 I InputReader: Device reconfigured: id\u003d16, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, size 1080x600, orientation 0, mode 4, display id 0\n08-03 16:41:32.297   613   711 I InputReader: Device added: id\u003d16, eventHubId\u003d19, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, descriptor\u003d\u0027281647cb23c613e9487705dd51a0705b6ed6da26\u0027,sources\u003d0x00002002\n08-03 16:41:32.297   613   711 I InputReader: Device added: id\u003d16, eventHubId\u003d18, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027, descriptor\u003d\u0027281647cb23c613e9487705dd51a0705b6ed6da26\u0027,sources\u003d0x04002002\n08-03 16:41:32.351   613   711 I InputReader: Device added: id\u003d16, eventHubId\u003d17, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027, descriptor\u003d\u0027281647cb23c613e9487705dd51a0705b6ed6da26\u0027,sources\u003d0x05002513\n\nEventHub allocates the same descriptor for each device path (/dev/input/eventXX) it opened. The same descriptor was allocated because the vendor, product, and version were populated and it had a unique id set. InputReader only created one device (id\u003d16) and updated the sources on that devices (sources\u003dsources\u003d0x00002002, sources\u003d0x04002002, sources\u003d0x05002513) as additional device paths were read since they all had the same descriptor in EventHub.\n\nThis device was then passed back to VirtualInputDevice in the test and it passed because it found a single device (id\u003d16) with matching sources:\n\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice: updateInputDevice deviceId: 16 device: Input Device 16: Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Descriptor: 281647cb23c613e9487705dd51a0705b6ed6da26\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Generation: 62\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Location: external\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Keyboard Type: non-alphabetic\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Has Vibrator: true\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Has Sensor: true\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Has battery: true\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Has mic: false\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:   Sources: 0x5002513 ( keyboard mouse joystick gamepad )\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_HAT_Y: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_HAT_X: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_RTRIGGER: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_GAS: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_RZ: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_Z: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_LTRIGGER: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_BRAKE: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_Y: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_X: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_X: source\u003d0x2002 min\u003d0.0 max\u003d1079.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_Y: source\u003d0x2002 min\u003d0.0 max\u003d599.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 16:41:32.362  2684  2743 I VirtualInputDevice:     AXIS_PRESSURE: source\u003d0x2002 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n\n(continued in next comment)",
      "parentUuid": "31d83fef_0649ae35",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2b6f4651_72e4926d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-04T13:48:22Z",
      "side": 1,
      "message": "Here is the same logging output with this patch applies where the test fails:\n08-03 17:02:49.308     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) as /devices/virtual/misc/uhid/0003:054C:0CE6.0001/input/input14\n08-03 17:02:49.309     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors as /devices/virtual/misc/uhid/0003:054C:0CE6.0001/input/input15\n08-03 17:02:49.310     0     0 I input   : Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad as /devices/virtual/misc/uhid/0003:054C:0CE6.0001/input/input16\n08-03 17:02:49.260   645   737 I EventHub: Opening device: /dev/input/event13\n08-03 17:02:49.260   645   737 I EventHub: add device 14: /dev/input/event13\n08-03 17:02:49.260   645   737 I EventHub:   bus:        0003\n08-03 17:02:49.260   645   737 I EventHub:   vendor      054c\n08-03 17:02:49.260   645   737 I EventHub:   product     0ce6\n08-03 17:02:49.260   645   737 I EventHub:   version     8000\n08-03 17:02:49.260   645   737 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test)\"\n08-03 17:02:49.260   645   737 I EventHub:   location:   \"\"\n08-03 17:02:49.260   645   737 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 17:02:49.260   645   737 I EventHub:   descriptor: \"281647cb23c613e9487705dd51a0705b6ed6da26\"\n08-03 17:02:49.260   645   737 I EventHub:   driver:     v1.0.1\n08-03 17:02:49.261   645   737 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027.\n08-03 17:02:49.261   645   737 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 17:02:49.265   645   737 W EventHub: Unable to disable kernel key repeat for /dev/input/event13: Function not implemented\n08-03 17:02:49.265   645   737 I EventHub: usingClockIoctl\u003dtrue\n08-03 17:02:49.265   645   737 I EventHub: New device: id\u003d14, fd\u003d396, path\u003d\u0027/dev/input/event13\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027, classes\u003dKEYBOARD | GAMEPAD | JOYSTICK | VIBRATOR | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027/system/usr/keylayout/Vendor_054c_Product_0ce6.kl\u0027, keyCharacterMap\u003d\u0027/system/usr/keychars/Generic.kcm\u0027, builtinKeyboard\u003dfalse, \n08-03 17:02:49.267   645   737 I InputReader: Device added: id\u003d15, eventHubId\u003d14, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test)\u0027, descriptor\u003d\u0027281647cb23c613e9487705dd51a0705b6ed6da26\u0027,sources\u003d0x01000511\n08-03 17:02:49.268   645   737 I EventHub: Opening device: /dev/input/event14\n08-03 17:02:49.268   645   737 I EventHub: add device 15: /dev/input/event14\n08-03 17:02:49.268   645   737 I EventHub:   bus:        0003\n08-03 17:02:49.268   645   737 I EventHub:   vendor      054c\n08-03 17:02:49.268   645   737 I EventHub:   product     0ce6\n08-03 17:02:49.268   645   737 I EventHub:   version     8000\n08-03 17:02:49.268   645   737 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\"\n08-03 17:02:49.268   645   737 I EventHub:   location:   \"\"\n08-03 17:02:49.268   645   737 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 17:02:49.268   645   737 I EventHub:   descriptor: \"471e623992d3ed7706cf4908bad7bb20bb45923d\"\n08-03 17:02:49.268   645   737 I EventHub:   driver:     v1.0.1\n08-03 17:02:49.268   645   737 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027.\n08-03 17:02:49.268   645   737 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 17:02:49.269   645   737 I EventHub: usingClockIoctl\u003dtrue\n08-03 17:02:49.269   645   737 I EventHub: New device: id\u003d15, fd\u003d410, path\u003d\u0027/dev/input/event14\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027, classes\u003dSENSOR | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027/system/usr/keylayout/Vendor_054c_Product_0ce6.kl\u0027, keyCharacterMap\u003d\u0027/system/usr/keychars/Generic.kcm\u0027, builtinKeyboard\u003dfalse, \n08-03 17:02:49.270   645   737 I EventHub: Opening device: /dev/input/event15\n08-03 17:02:49.270   645   737 I EventHub: add device 16: /dev/input/event15\n08-03 17:02:49.270   645   737 I EventHub:   bus:        0003\n08-03 17:02:49.270   645   737 I EventHub:   vendor      054c\n08-03 17:02:49.270   645   737 I EventHub:   product     0ce6\n08-03 17:02:49.270   645   737 I EventHub:   version     8000\n08-03 17:02:49.270   645   737 I EventHub:   name:       \"Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\"\n08-03 17:02:49.270   645   737 I EventHub:   location:   \"\"\n08-03 17:02:49.270   645   737 I EventHub:   unique id:  \"00:00:00:00:00:00\"\n08-03 17:02:49.270   645   737 I EventHub:   descriptor: \"dc025fffdf6e452646d52f4ce385b98ed007d7f5\"\n08-03 17:02:49.270   645   737 I EventHub:   driver:     v1.0.1\n08-03 17:02:49.270   645   737 D EventHub: No input device configuration file found for device \u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027.\n08-03 17:02:49.270   645   737 D EventHub: configureBatteryLocked rawBatteryId 1 name ps-controller-battery-00:00:00:00:00:00\n08-03 17:02:49.271   645   737 I EventHub: usingClockIoctl\u003dtrue\n08-03 17:02:49.271   645   737 I EventHub: New device: id\u003d16, fd\u003d476, path\u003d\u0027/dev/input/event15\u0027, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, classes\u003dTOUCH | TOUCH_MT | BATTERY | EXTERNAL, configuration\u003d\u0027\u0027, keyLayout\u003d\u0027\u0027, keyCharacterMap\u003d\u0027\u0027, builtinKeyboard\u003dfalse,\n08-03 17:02:49.286   645   737 I InputReader: Device reconfigured: id\u003d16, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, size 1080x600, orientation 0, mode 4, display id 0\n08-03 17:02:49.286   645   737 I InputReader: Device added: id\u003d16, eventHubId\u003d16, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\u0027, descriptor\u003d\u0027dc025fffdf6e452646d52f4ce385b98ed007d7f5\u0027,sources\u003d0x00002002\n08-03 17:02:49.286   645   737 I InputReader: Device added: id\u003d17, eventHubId\u003d15, name\u003d\u0027Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\u0027, descriptor\u003d\u0027471e623992d3ed7706cf4908bad7bb20bb45923d\u0027,sources\u003d0x04000000\n\nYou can see now that EventHub allocates a different descriptor for each device and InputRead makes three separate devices (id\u003d15, id\u003d16, id\u003d17) since the descriptors in EventHub are different. Each device has its own set of InputSources instead of a single device with combined InputSources.\n\nThis gets passed to VirtualDevice in the test as 3 separate InputDevices and we get a source mismatch on each device as it is expecting a single device with combined InputSources:\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice: updateInputDevice deviceId: 15 device: Input Device 15: Sony DualSense (model 409B-CFIZCT1)(USB Test)\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Descriptor: 281647cb23c613e9487705dd51a0705b6ed6da26\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Generation: 46\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Location: external\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Keyboard Type: non-alphabetic\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Has Vibrator: true\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Has Sensor: false\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Has battery: true\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Has mic: false\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:   Sources: 0x1000511 ( keyboard joystick gamepad )\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_HAT_Y: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_HAT_X: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_RTRIGGER: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_GAS: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_RZ: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_Z: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_LTRIGGER: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_BRAKE: source\u003d0x1000010 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_Y: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice:     AXIS_X: source\u003d0x1000010 min\u003d-1.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.278  3386  3436 I VirtualInputDevice: Mismatching sources. Sources: 1000511 mSources: 5002513 device: Input Device 15: Sony DualSense (model 409B-CFIZCT1)(USB Test)\n\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice: updateInputDevice deviceId: 16 device: Input Device 16: Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Descriptor: dc025fffdf6e452646d52f4ce385b98ed007d7f5\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Generation: 50\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Location: external\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Keyboard Type: none\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has Vibrator: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has Sensor: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has battery: true\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has mic: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Sources: 0x2002 ( mouse )\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_X: source\u003d0x2002 min\u003d0.0 max\u003d1079.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_Y: source\u003d0x2002 min\u003d0.0 max\u003d599.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_PRESSURE: source\u003d0x2002 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice: Mismatching sources. Sources: 2002 mSources: 5002513 device: Input Device 16: Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\n\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice: updateInputDevice deviceId: 16 device: Input Device 16: Sony DualSense (model 409B-CFIZCT1)(USB Test) Touchpad\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Descriptor: dc025fffdf6e452646d52f4ce385b98ed007d7f5\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Generation: 50\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Location: external\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Keyboard Type: none\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has Vibrator: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has Sensor: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has battery: true\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Has mic: false\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:   Sources: 0x2002 ( mouse )\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_X: source\u003d0x2002 min\u003d0.0 max\u003d1079.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_Y: source\u003d0x2002 min\u003d0.0 max\u003d599.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice:     AXIS_PRESSURE: source\u003d0x2002 min\u003d0.0 max\u003d1.0 flat\u003d0.0 fuzz\u003d0.0 resolution\u003d0.0\n08-03 17:02:49.370  3386  3436 I VirtualInputDevice: Mismatching sources. Sources: 4000000 mSources: 5002513 device: Input Device 17: Sony DualSense (model 409B-CFIZCT1)(USB Test) Motion Sensors\n\nThe case we missed when creating this patch is that sometime descriptors are supposed to be the same across input device paths (/dev/input/eventXX) when a single physical device has multiple input sources.\n\nI can restate the original problem I am trying to solve with this patch though. I am trying to differentiate between multiple touchpanels that are separate physical devices but have the same vendor, product, version and unique id field. This scenario is coming from an automotive multi-display setup where we have the multiple identical screens with touchpanels plugged into usb. \n\nIt looks like we are using the unique id field to detect multiple input sources on a single device with the assumption that it should be unique across physical devices. The proposal I came up with to allow this to still work for my case it to look at both the unique id and the location field. If both the unique id field is set then look at the location field. If the location field is set see if there is another device with the same vendor, product, version, unique id and location. If there is then treat it as a sub device and allow it to have the same descriptor. If there is a device with the same vendor, product, version, and unique id, but a different location then treat it as a new device (new descriptor). I think we still have to leave the location out of the descriptor generation itself as we don\u0027t want to have the descriptor change when the device is plugged into a different physical port.\n\nLet me know if this proposal make sense to you. I have not worked on implementing it yet, but I think it should be fairly easy to implement and test.",
      "parentUuid": "b4e8bde5_8739815b",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d6b43f35_6b5461ba",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1149384
      },
      "writtenOn": "2022-08-04T15:27:30Z",
      "side": 1,
      "message": "Hi Joshua,\n\nThat sounds reasonable.\nAnother option is to use \"vendor / product / version / bus / uniq\" fields in order to detect sub-devices (not in eventhub, but higher up), and keep allowing the \u0027descriptor\u0027 field to be unique for every eventhub device.\n\nYour solution seems simpler, though.",
      "parentUuid": "2b6f4651_72e4926d",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1633f688_eeecc4b9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 6
      },
      "lineNbr": 0,
      "author": {
        "id": 1002669
      },
      "writtenOn": "2022-08-04T17:03:44Z",
      "side": 1,
      "message": "Thanks. Patchset #7 has the additional check for location I proposed above. I put the check for unique_id and location in a separate function named isSubDevice and added some documentation there to explain what a sub-device is and why the check is needed. This was the best way I could think of to make it easy to read and still keep good documentation with the code. Let me know if there are any additional concerns with this approach.",
      "parentUuid": "d6b43f35_6b5461ba",
      "revId": "2519d37b171d8d221e2eb1a38833a4e0e4784e4c",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}