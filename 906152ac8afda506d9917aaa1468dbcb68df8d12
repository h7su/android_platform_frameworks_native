{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "e4080b97_13773bb8",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 11,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-06-30T07:17:04Z",
      "side": 1,
      "message": "Does this assume that the new hook mechanism is used only to attach/detach Java threads? What happens if a client has registered a different hook?",
      "range": {
        "startLine": 10,
        "startChar": 34,
        "endLine": 11,
        "endChar": 34
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "77a55b15_65364fc9",
        "filename": "/COMMIT_MSG",
        "patchSetId": 3
      },
      "lineNbr": 11,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:43:12Z",
      "side": 1,
      "message": "\u003e Does this assume that the new hook mechanism is used only to attach/detach Java threads?\n\nFrom libbinder\u0027s perspective, the hook can be used however the client wants. Right now it is only used for attaching / detaching Java threads.\n\nHence, this text is only in the commit message, not in the code comments.",
      "parentUuid": "e4080b97_13773bb8",
      "range": {
        "startLine": 10,
        "startChar": 34,
        "endLine": 11,
        "endChar": 34
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c565e18b_7651dacd",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-06-30T07:17:04Z",
      "side": 1,
      "message": "This looks odd to me because this parameter is used for both Pre and Post hooks. I know that this works because the type of the two functions are the same, but still that doesn\u0027t look intuitive to me.\n\nI don\u0027t have a strong opinion, but wish that this can be written as ...\n\nvoid runHook(bool pre) {\n    if (pre) {getThreadPreHook(...);}\n    else {getThreadPostHook(...);}\n    ...\n}\n\nor\n\ntemplate\u003ctypename F\u003e\nvoid runHook(F getter) { ... }\n\nthough the latter generates slightly bigger code.",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cd8ced59_d3fc7134",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-06-30T16:36:20Z",
      "side": 1,
      "message": "can we avoid exposing the getters completely?\n\nthis seems very weird \"action at a distance\" to me --- someone set a global thread hook (which is itself a somewhat confusing concept --- i\u0027d assumed they were meant to be per-thread, not global) and it magically infects this code?",
      "parentUuid": "c565e18b_7651dacd",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "72932ee8_ad873bd0",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-06-30T16:52:33Z",
      "side": 1,
      "message": "agreed, see:\nhttps://android-review.googlesource.com/c/platform/system/core/+/1751787/5/libutils/Threads.cpp#67\n\nThough, I know the pre/post-hook things might have been my suggestion, but I\u0027m wondering, could we use javaCreateThreadEtc here? Is it possible to create a android_thread_func_t function here, and we can pass this to the existing API?",
      "parentUuid": "cd8ced59_d3fc7134",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "aa2be175_0c7696fa",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-06-30T17:06:56Z",
      "side": 1,
      "message": "oops see also https://android-review.googlesource.com/c/platform/frameworks/base/+/1751551/1/core/jni/AndroidRuntime.cpp#1593\n\nPlease ignore the javaCreateThreadEtc/android_thread_func_t suggestion. We needed the hooks specifically because we want to attach the JVM even for some threads which we don\u0027t create (where we join).",
      "parentUuid": "72932ee8_ad873bd0",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "44d5aece_a954eaad",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:33:05Z",
      "side": 1,
      "message": "They were indeed meant to be global, not per-thread. See my explanation in https://android-review.googlesource.com/c/platform/system/core/+/1751787/5..8/libutils/Threads.cpp#b67.\n\nIt is meant to magically infects this code, indeed. This is so that libbinder can call vm-\u003eAttachThread in zygote and not call it in other processes. libbinder itself doesn\u0027t know anything about JVM.",
      "parentUuid": "aa2be175_0c7696fa",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bd0ab5b0_91da38d7",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:43:12Z",
      "side": 1,
      "message": "Resolving. Elliot, do you have any concerns with this?",
      "parentUuid": "44d5aece_a954eaad",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "10800975_5dc7630e",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-06-30T22:48:48Z",
      "side": 1,
      "message": "\u003e Elliot, do you have any concerns with this?\n\nyeah, i really don\u0027t like \"It is meant to magically infects this code, indeed\". that feels like we\u0027re making things worse from a libutils/pthread_create/std::thread interop perspective.\n\nif libbinder needs to know whether it\u0027s running in the zygote or not, can\u0027t it use a weak symbol or something?",
      "parentUuid": "bd0ab5b0_91da38d7",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3d048013_e2ecdbd8",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:58:58Z",
      "side": 1,
      "message": "I am more than happy to switch over to weak symbols, if that\u0027s preferable! :D\n\nHere\u0027s the plan:\n\nIn libutils/AndroidThreads.h:\n\n```\nvoid runThreadPreHook() __attribute__((weak));\nvoid runThreadPostHook() __attribute__((weak));\n\nint thread_data_t::trampoline(...) {\n    if (runThreadPreHook) runThreadPreHook();\n    entryFunction();\n    if (runThreadPostHook) runThreadPostHook();\n}\n```\n\nIn libandroid_runtime:\n\n```\nvoid runThreadPreHook() { javaAttachThread(); }\nvoid runThreadPostHook() { javaDetachThread(); }\nint javaAttachThread() {\n    char threadName[16];\n    pthread_getname_np(pthread_self(), threadName, sizeof(threadName));\n    // ...\n} \n```\n\nIn libbinder:\n```\nvoid RpcSession::join() {\n    runThreadPreHook();\n    while (...) {};\n    runThreadPostHook();\n}\n```\n\nIf you like this, I\u0027ll start the work. Otherwise, let me know how you would like this to be.",
      "parentUuid": "10800975_5dc7630e",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9c8a7482_9083eadb",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-06-30T23:07:09Z",
      "side": 1,
      "message": "no, i meant \"let\u0027s not add stuff to libutils at all, let\u0027s give libbinder a way to know whether it\u0027s running in a zygote context --- that would also work equally well for std::thread and pthread_create()\".",
      "parentUuid": "3d048013_e2ecdbd8",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e3acf84e_0f45f43c",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T23:12:40Z",
      "side": 1,
      "message": "You mean:\n\nDon\u0027t change anything in libutils.\n\nIn libandroid_runtime, expose javaAttachThread and javaDetachThread by deleting the \"static\" keyword\n\nIn libbinder, declare javaAttachThread and javaDetachThread as weak symbols, and run them when necessary\n\n?",
      "parentUuid": "9c8a7482_9083eadb",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b407b316_720a7c5c",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T23:16:20Z",
      "side": 1,
      "message": "I would probably add a new libandroid_runtime_threads_headers header lib too, to declare the two weak symbols",
      "parentUuid": "e3acf84e_0f45f43c",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bb4c843f_2ee5ea41",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1003224
      },
      "writtenOn": "2021-06-30T23:19:52Z",
      "side": 1,
      "message": "yeah, something like that.",
      "parentUuid": "b407b316_720a7c5c",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "974609fd_2376144c",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-07-01T01:32:47Z",
      "side": 1,
      "message": "See new patchset.\n\nThis actually doesn\u0027t work; within libbinder, javaAttachThread is always resolved to nullptr. I suspect it is because libbinder is loaded before libandroid_runtime (because libbinder is a dependency of libandroid_runtime), and javaAttachThread is in libbinder\u0027s symbols table, and gets resolved to null.\n\nMaybe instead of using weak symbols, I should use dlopen(NULL) instead?",
      "parentUuid": "bb4c843f_2ee5ea41",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a9540244_4d867158",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-07-01T02:35:03Z",
      "side": 1,
      "message": "I can confirm that dlsym(RTLD_DEFAULT) works. See new patchset.",
      "parentUuid": "974609fd_2376144c",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "78d76429_5353c43c",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 286,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-07-01T07:09:58Z",
      "side": 1,
      "message": "Maybe it didn\u0027t work because I forgot the extern keyword. Let me try the weak symbol approach one more time",
      "parentUuid": "a9540244_4d867158",
      "range": {
        "startLine": 286,
        "startChar": 17,
        "endLine": 286,
        "endChar": 44
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bf26c37c_349e4973",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 296,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2021-06-30T07:17:04Z",
      "side": 1,
      "message": "I don\u0027t understand what the the name is used for in the hook routines, especially given that it falls back to the default name \u0027RpcBinder\u0027.",
      "range": {
        "startLine": 292,
        "startChar": 0,
        "endLine": 296,
        "endChar": 9
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "683bad83_41dec337",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 296,
      "author": {
        "id": 1120458
      },
      "writtenOn": "2021-06-30T16:34:21Z",
      "side": 1,
      "message": "It\u0027s used as the thread name. +1 - see \u0027ProcessState::makeBinderThreadName\u0027. I don\u0027t think we\u0027ll need any more information in the thread name (we don\u0027t really need numbers - we have TIDs). Maybe call it RpcSessionThread for now?",
      "parentUuid": "bf26c37c_349e4973",
      "range": {
        "startLine": 292,
        "startChar": 0,
        "endLine": 296,
        "endChar": 9
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3fd8ca06_45317ccd",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 296,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:33:05Z",
      "side": 1,
      "message": "L293 is meant to be the default thread name. Normally, the thread name should be retrieved in L295.\n\nThe hook itself requires me to provide a thread name for logging purposes:\n\nhttps://android-review.googlesource.com/c/platform/frameworks/base/+/1751551/1/core/jni/AndroidRuntime.cpp#1349",
      "parentUuid": "683bad83_41dec337",
      "range": {
        "startLine": 292,
        "startChar": 0,
        "endLine": 296,
        "endChar": 9
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a9b8514b_72d9987e",
        "filename": "libs/binder/RpcSession.cpp",
        "patchSetId": 3
      },
      "lineNbr": 296,
      "author": {
        "id": 1121838
      },
      "writtenOn": "2021-06-30T22:43:12Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3fd8ca06_45317ccd",
      "range": {
        "startLine": 292,
        "startChar": 0,
        "endLine": 296,
        "endChar": 9
      },
      "revId": "906152ac8afda506d9917aaa1468dbcb68df8d12",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}