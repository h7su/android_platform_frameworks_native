// The Rust test harness doesn't let us run anything on the main thread, and we
// need to initialize IPCThreadState there. This is a tiny hack to do this.
cc_library_static {
    name: "libbinder_rs_test_init_hack",
    shared_libs: [
        "libbinder_ndk",
    ],
    srcs: [
        "MainThreadInit.cpp",
    ],
}

rust_test {
    name: "rustBinderTest",
    srcs: ["integration.rs"],
    edition: "2018",
    static_libs: [
        "libbinder_rs_test_init_hack",
    ],
    rustlibs: [
        "libbinder_rs",
    ],
    flags: [
        "-C debuginfo=2",
        "-C opt-level=0",
    ],
}

// Create a C++ test server to communicate with for serialization
cc_library_static {
    name: "libbinder_rs_serialization_test",
    shared_libs: [
        "libbinder",
    ],
    srcs: [
        "serialization.cpp",
    ],
}

rust_test {
    name: "rustSerializationTest",
    srcs: ["serialization.rs"],
    edition: "2018",
    shared_libs: [
        "libbinder",
        "libc++",
    ],
    static_libs: [
        "libbinder_rs_test_init_hack",
        "libbinder_rs_serialization_test",
    ],
    rlibs: [
        "libbinder_rs",
        "liblibc",
    ],
    flags: [
        "-C debuginfo=2",
        "-C opt-level=0",
    ],
}
